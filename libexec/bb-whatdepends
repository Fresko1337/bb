#!/usr/bin/env python3
# Usage: bb whatdepends [-h] [-r] target [recipes [recipes ...]]
# Summary: Show what depends on the specified target
# Help: See bb whatdepends -h for detailed usage information.

import logging
import sys
import bbcmd


logger = logging.getLogger('bb.whatdepends')


def whatdepends(args):
    """Show what depends on the specified target"""

    # tinfoil sets up log output for the bitbake loggers, but bb uses
    # a separate namespace at this time
    bbcmd.setup_log_handler(logging.getLogger('bb'))

    tinfoil = bbcmd.Tinfoil(output=sys.stderr)
    tinfoil.prepare()

    recipes = list(args.recipes)
    recipes.append(args.target)
    with bbcmd.status('Preparing task data'):
        tinfoil.prepare_taskdata(recipes)

    ignored = tinfoil.cooker.recipecache.ignored_dependencies | set(['universe', 'world'])
    for recipe in recipes:
        if (not tinfoil.taskdata.have_build_target(recipe) and
            recipe not in ignored):
            logger.error('No build target for %s' % recipe)
            return 1

    provmap = tinfoil.taskdata.get_providermap()
    filename = provmap.get(args.target)

    if args.recursive:
        if args.run_time_only:
            func = tinfoil.rec_get_rdependees
        elif args.build_time_only:
            func = tinfoil.rec_get_dependees
        else:
            func = tinfoil.rec_get_all_dependees

        for dep_fn, depth, was_seen in func(filename):
            dep_target = tinfoil.cache_data.pkg_fn[dep_fn]
            print('  '*depth + dep_target + ('..' if was_seen else ''))
    else:
        if args.run_time_only:
            func = tinfoil.get_rdependees
        elif args.build_time_only:
            func = tinfoil.get_dependees
        else:
            func = tinfoil.get_all_dependees

        for dep_fn in func(filename):
            dep_target = tinfoil.cache_data.pkg_fn[dep_fn]
            print(dep_target)


# provide bb completions
def main(arguments):
    default_scope = os.getenv('BB_RECIPE_SCOPE') or 'universe'
    parser = bbcmd.CompleteParser()
    parser.add_argument('-r', '--recursive', action='store_true',
                        help='operate recursively, with indent reflecting depth')
    namespace = parser.add_mutually_exclusive_group()
    namespace.add_argument('-B', '--build-time-only', action='store_true',
                           help='show build-time dependencies only')
    namespace.add_argument('-R', '--run-time-only', action='store_true',
                           help='show run-time dependencies only')
    parser.add_argument('target')
    parser.add_argument('recipes', default=[default_scope], nargs='*',
                        help='recipes to check for dependencies on target (default: universe)')
    args = parser.parse_args(arguments)
    if args is None:
        # showing completions
        return
    else:
        return whatdepends(args)


if __name__ == '__main__':
    bbcmd.run_main(main)
